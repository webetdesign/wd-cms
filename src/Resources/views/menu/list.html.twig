{% extends '@SonataAdmin/CRUD/base_list.html.twig' %}

{%- block actions -%}
    <li>
        {% if root %}
            <a class="sonata-action-element sonata-action-element__cms-menu" href="{{ admin.generateUrl('create', {target: root.id}) }}">
                <i class="fa fa-plus-circle" aria-hidden="true"></i>
                {{ 'link_action_create'|trans({}, 'SonataAdminBundle') }}
            </a>
        {% endif %}
    </li>
{%- endblock -%}

{% block list_table %}
    {% set items = admin.datagrid.results %}
    {% if admin.datagrid.results|length == 0 %}
        <div class="col-xs-12">
            <div class="alert alert-danger" role="alert">
                Aucune configuration détecté, <a href="{{ path('admin_webetdesign_cms_cmsmenu_createRootNode') }}">Initaliser avec le menu par defaut !</a>
            </div>
        </div>
    {% else %}
        <div class="col-xs-6 col-md-6">
            <div class="nav-tabs-custom">
                {% set label = false %}
                <ul class="nav nav-tabs" role="tablist">
                    {% for rootNode in rootNodes %}
                        {% if rootNode.lvl == 0 %}
                            <li role="presentation" class="menu-tab {{ loop.first ? 'active' : '' }}" data-id="{{ rootNode.id }}">
                                {% for site in sites %}
                                    {% set label = false %}
                                    {% if site.menu == rootNode %}
                                        {% set label = true %}
                                        <a href="#tab_{{ rootNode.id }}" aria-controls="tab_{{ rootNode.id }}" role="tab" data-toggle="tab">{{ site.label }}</a>
                                    {% endif %}
                                {% endfor %}
                                {% if not label %}
                                    <a href="#tab_{{ rootNode.id }}" aria-controls="tab_{{ rootNode.id }}" role="tab" data-toggle="tab">{{ rootNode.name}}</a>
                                {% endif %}
                            </li>
                        {% endif %}
                    {% endfor %}
                    <li style="float: right">
                        <span data-url="{{ admin.generateUrl('create') }}" id="add_global_btn"> <i class="fa fa-plus"></i> Ajouter un menu</span>
                    </li>

                    {#<li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Profile</a></li>#}
                    {#<li role="presentation"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">Messages</a></li>#}
                    {#<li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a></li>#}
                </ul>

                <div class="tab-content">
                    <!-- Tab panes -->
                    {% for rootNode in rootNodes %}
                        <div class="cmsMenuAdmin tab-pane {{ loop.first ? 'active' : '' }}" role="tabpanel" id="tab_{{ rootNode.id }}" data-move-url="{{ url('admin_webetdesign_cms_cmsmenu_move', [], true) }}">
                            {% for item in items if item.lvl == 1 and item.parent == rootNode %}
                                <div class="box box-primary">
                                    <div class="box-header item-data" data-id="{{ item.id }}" data-edit-url="{{ admin.generateUrl('edit', {id: item.id}) }}" data-add-url="{{ admin.generateUrl('create', {target: item.id}) }}">
                                        <h4 class="box-title">{{ item.name }} <code>{{ item.code }}</code></h4>
                                        <button class="cms-menu-item__btn-edit"><i class="fa fa-pencil"></i></button>
                                        <button class="cms-menu-item__btn-add"><i class="fa fa-plus"></i></button>
                                    </div>
                                    <div class="box-body">
                                        {% set menu = knp_menu_get('cmsAdminMenu', [], {code: item.code, admin: admin}) %}
                                        {{ knp_menu_render(menu, [], 'cms_menu_admin_renderer') }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {#<div class="cmsMenuAdmin" data-move-url="{{ url('admin_webetdesign_cms_cmsmenu_move', [], true) }}">#}
                {#{% set items = admin.datagrid.results %}#}
                {#{% for item in items if item.lvl == 1 and item.parent == rootNode %}#}
                    {#<div class="box box-primary">#}
                        {#<div class="box-header item-data" data-id="{{ item.id }}" data-edit-url="{{ admin.generateUrl('edit', {id: item.id}) }}" data-add-url="{{ admin.generateUrl('create', {target: item.id}) }}">#}
                            {#<h4 class="box-title">{{ item.name }} <code>{{ item.code }}</code></h4>#}
                            {#<button class="cms-menu-item__btn-edit"><i class="fa fa-pencil"></i></button>#}
                            {#<button class="cms-menu-item__btn-add"><i class="fa fa-plus"></i></button>#}
                        {#</div>#}
                        {#<div class="box-body">#}
                            {#{% set menu = knp_menu_get('cmsAdminMenu', [], {code: item.code, admin: admin}) %}#}
                            {#{{ knp_menu_render(menu, [], 'cms_menu_admin_renderer') }}#}
                        {#</div>#}
                    {#</div>#}
                {#{% endfor %}#}
            {#</div>#}
            <br><br>
        </div>
        <div class="col-xs-6 col-md-6">
            <div class="edit-container" style="display: none">

            </div>
        </div>
    {% endif %}
    <script>
        var time = 100;
        $(document).ready(function () {
            $('#add_global_btn').on('click', function (e) {
                var url = $(this).data('url');
                var id = $('.menu-tab.active').data('id');
                showForm(url + '?target=' + id)
            })

        })

        function showForm (url) {
            setTimeout(function () {

                $.get(url, function (response) {
                    $('.edit-container').empty().append(response);
                    $('.edit-container').fadeIn();
                })
            }, time)
        }
    </script>
{% endblock %}
