parameters:
  cms.admin.cms_page_listener.class: WebEtDesign\CmsBundle\EventListener\PageAdminListener
  cms.admin.cms_site_listener.class: WebEtDesign\CmsBundle\EventListener\SiteAdminListener
  cms.admin.cms_shared_block_listener.class: WebEtDesign\CmsBundle\EventListener\SharedBlockAdminListener
  cms.admin.cms_site_entity_listener.class: WebEtDesign\CmsBundle\EventListener\CmsSiteListener

services:
  WebEtDesign\CmsBundle\Form\PageTemplateType:
    arguments:
      - '@cms.page_provider'
    tags:
      - { name: form.type }

  WebEtDesign\CmsBundle\Form\BlockTemplateType:
    arguments:
      - '@cms.block_provider'
    tags:
      - { name: form.type }

  WebEtDesign\CmsBundle\Form\MultilingualType:
    arguments:
      - '@doctrine.orm.default_entity_manager'
      - '%wd_cms.admin.config.entity.page%'
      - '%wd_cms.admin.config.entity.site%'
    tags:
      - { name: form.type }

  WebEtDesign\CmsBundle\Form\GlobalVarsType:
    arguments:
      - '@cms.page_provider'
      - '@service_container'
      - '%wd_cms.vars%'
    tags:
      - { name: form.type }

  WebEtDesign\CmsBundle\Form\CmsRouteParamsType:
    arguments:
      - '@doctrine.orm.entity_manager'
    tags:
      - { name: form.type }

  cms.routing_loader:
    class: WebEtDesign\CmsBundle\Routing\ExtraLoader
    public: true
    arguments: ['@doctrine.orm.entity_manager', '@parameter_bag']
    tags:
      - { name: routing.loader }

  cms.helper:
    class: WebEtDesign\CmsBundle\Services\CmsHelper
    arguments: ['@doctrine.orm.entity_manager', '@cms.page_provider', '@twig', "@security.authorization_checker"]
    public: true

  # TODO: Won't work if not in autowire directories
  WebEtDesign\CmsBundle\Services\TemplateProvider:
    arguments:
      $config: '%wd_cms.templates%'

  cms.page_provider:
    alias: WebEtDesign\CmsBundle\Services\TemplateProvider
    public: true

  cms.block_provider:
    class: WebEtDesign\CmsBundle\Services\TemplateProvider
    arguments:
      $config: '%wd_cms.shared_block%'

  cms.admin.crud_button:
    class: WebEtDesign\CmsBundle\Block\CRUDButtonBlock
    arguments:
      - ~
      - '@templating'
      - '@sonata.admin.pool'
    tags:
      - { name: sonata.block }

  # ===============================================
  # Command
  # ===============================================

  WebEtDesign\CmsBundle\Command\CmsMigrationArboCommand:
    arguments:
      - ~
      - '@doctrine.orm.default_entity_manager'
    tags:
      - { name: 'console.command', command: 'cms:migration-arbo' }

  WebEtDesign\CmsBundle\Command\CmsGenerateContentsPositionCommand:
    arguments:
      - ~
      - '@doctrine.orm.default_entity_manager'
    tags:
      - { name: 'console.command', command: 'cms:gen-contents-position' }

  WebEtDesign\CmsBundle\Command\CmsResetContentCommand:
    arguments:
      - ~
      - '@doctrine.orm.default_entity_manager'
      - '@cms.page_provider'
    tags:
      - { name: 'console.command', command: 'cms:reset-content' }


  # ===============================================
  # LISTENER
  # ===============================================

  cms.admin.cms_page_listener:
    class: '%cms.admin.cms_page_listener.class%'
    arguments:
      - '@cms.page_provider'
      - '@doctrine.orm.entity_manager'
      - '@router'
      - '@filesystem'
      - '@kernel'
      - '%wd_cms.admin.config.entity.route%'
      - '%wd_cms.cms%'
      - '%wd_cms.custom_contents%'
      - '@service_container'
    tags:
      - { name: doctrine.event_listener, event: prePersist }
      - { name: doctrine.event_listener, event: postPersist }
      - { name: doctrine.event_listener, event: postUpdate }
      - { name: doctrine.event_listener, event: preRemove }
      - { name: doctrine.event_listener, event: postLoad }

  cms.admin.cms_page_declination_listener:
    class: WebEtDesign\CmsBundle\EventListener\PageDeclinationAdminListener
    arguments:
      - '@doctrine.orm.entity_manager'
    tags:
      - { name: doctrine.event_listener, event: prePersist }

  cms.admin.cms_site_listener:
    class: '%cms.admin.cms_site_listener.class%'
    arguments:
      - '@router'
      - '@filesystem'
      - '@kernel'
      - '%wd_cms.admin.config.entity.site%'
    tags:
      - { name: doctrine.event_listener, event: prePersist }
      - { name: doctrine.event_listener, event: postPersist }
      - { name: doctrine.event_listener, event: postUpdate }

  cms.admin.cms_route_listener:
    class: WebEtDesign\CmsBundle\EventListener\RouteAdminListener
    arguments:
      - '@router'
      - '@filesystem'
      - '@kernel'
    tags:
      - { name: doctrine.event_listener, event: postUpdate }

  cms.admin.cms_menu_listener:
    class: 'WebEtDesign\CmsBundle\EventListener\MenuAdminListener'
    tags:
      - { name: doctrine.event_listener, event: postPersist }



  cms.admin.cms_shared_block_listener:
    class: '%cms.admin.cms_shared_block_listener.class%'
    arguments:
      - '@cms.block_provider'
      - '@doctrine.orm.entity_manager'
      - '@router'
      - '@filesystem'
      - '@kernel'
      - '%wd_cms.admin.config.entity.route%'
    tags:
      - { name: kernel.event_listener, event: sonata.admin.event.persistence.pre_persist, method: buildSharedBlock }

  cms.shared_bloc_listner:
    class: WebEtDesign\CmsBundle\EventListener\SharedBlockListener
    arguments:
      - '%wd_cms.custom_contents%'
      - '@service_container'
    tags:
      - { name: doctrine.event_listener, event: postLoad }


  cms.controller.listener:
    class: WebEtDesign\CmsBundle\EventListener\CmsControllerListener
    arguments:
      - '@cms.helper'
      - '@cms.page_provider'
      - '@service_container'
      - '%wd_cms.vars%'
      - '%wd_cms.cms%'
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: onKernelController }

  # ===============================================
  # TWIG EXTENSION
  # ===============================================

  cms.twig.extension:
    class: WebEtDesign\CmsBundle\Twig\CmsTwigExtension
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@router'
      - '@service_container'
      - '@twig'
      - '@cms.page_provider'
      - '@cms.block_provider'
      - '@request_stack'
      - '@parameter_bag'
    tags:
      - { name: twig.extension }
    public: true

  # ===============================================
  # MENU
  # ===============================================

  cms.menu_builder:
    class: WebEtDesign\CmsBundle\Services\CmsMenuBuilder
    arguments:
      - "@knp_menu.factory"
      - "@doctrine.orm.entity_manager"
      - "@router"
      - "@security.token_storage"
      - "@security.authorization_checker"
      - "@request_stack"
    tags:
      - { name: knp_menu.menu_builder, method: cmsMenu, alias: cmsMenu }


  cms.menu_admin_builder:
    public: true
    class: WebEtDesign\CmsBundle\Services\CmsMenuAdminBuilder
    arguments:
      - "@knp_menu.factory"
      - "@doctrine.orm.entity_manager"
      - "@router"
    tags:
      - { name: knp_menu.menu_builder, method: cmsAdminMenu, alias: cmsAdminMenu }

  cms.menu_admin_renderer:
    # The class implements Knp\Menu\Renderer\RendererInterface
    class: Knp\Menu\Renderer\TwigRenderer
    arguments:
      - "@twig"
      - "@@WebEtDesignCms/menu/menu_admin_renderer.html.twig"
      - "@knp_menu.matcher"
      # add your own dependencies here
    tags:
      # The alias is what is used to retrieve the menu
      - { name: knp_menu.renderer, alias: 'cms_menu_admin_renderer' }

  # ===============================================
  # REPOSITORY
  # ===============================================

  WebEtDesign\CmsBundle\Repository\:
    resource: '../../Repository'
    autowire: true
    tags: ['doctrine.repository_service']

  # ===============================================
  # PROVIDERS
  # ===============================================

  cms.media.provider.svg:
    class: WebEtDesign\CmsBundle\Provider\SvgProvider
    tags:
      - { name: sonata.media.provider }
    arguments:
      - "cms.media.provider.svg"
      - "@sonata.media.filesystem.local"
      - "@sonata.media.cdn.server"
      - "@sonata.media.generator.default"
      - "@sonata.media.thumbnail.format"
      - ['svg']
      - ['image/svg+xml']

    calls:
      - [ setTemplates, [{ helper_thumbnail: '@@WebEtDesignCms/provider/SVG/thumbnail.html.twig', helper_view: '@@WebEtDesignCms/provider/SVG/view_svg.html.twig' }]]

  cms.media.provider.video:
    class: WebEtDesign\CmsBundle\Provider\VideoProvider
    tags:
      - { name: sonata.media.provider }
    arguments:
      - "cms.media.provider.video"
      - "@sonata.media.filesystem.local"
      - "@sonata.media.cdn.server"
      - "@sonata.media.generator.default"
      - "@sonata.media.thumbnail.format"
      - ['mp4','ogg','webm']
      - ['video/mp4','video/ogg','video/webm']

    calls:
      - [ setTemplates, [{ helper_thumbnail: '@@WebEtDesignCms/provider/Video/thumbnail.html.twig', helper_view: '@@WebEtDesignCms/provider/Video/view_video.html.twig' }]]


  # ===============================================
  # ADMIN
  # ===============================================

  cms.admin.cms_site:
    class: '%wd_cms.admin.config.class.site%'
    arguments: [~, '%wd_cms.admin.config.entity.site%', '%wd_cms.admin.config.controller.site%', '%wd_cms.cms%']
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Site}
    public: true

  cms.admin.cms_route:
    class: '%wd_cms.admin.config.class.route%'
    arguments: [~, '%wd_cms.admin.config.entity.route%', '%wd_cms.admin.config.controller.route%']
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Route, show_in_dashboard: false }
    public: true

  cms.admin.cms_page:
    class: '%wd_cms.admin.config.class.page%'
    arguments:
      - ~
      - '%wd_cms.admin.config.entity.page%'
      - '%wd_cms.admin.config.controller.page%'
      - '@doctrine.orm.default_entity_manager'
      - '%wd_cms.cms.multisite%'
      - '%wd_cms.cms.multilingual%'
      - '%wd_cms.cms.declination%'
      - '%wd_cms.vars%'
      - '@cms.page_provider'
      - '%wd_cms.custom_contents_form_themes%'
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Page }
    calls:
      - [setTemplate, ['edit', 'WebEtDesignCmsBundle:admin/page:edit.html.twig']]
      - [addChild, ['@cms.admin.cms_page_declination']]
    public: true

  cms.admin.cms_content:
    class: '%wd_cms.admin.config.class.content%'
    #        arguments: [~, '%wd_cms.admin.config.entity.content%', '%wd_cms.admin.config.controller.content%']
    arguments:
      - ~
      - '%wd_cms.admin.config.entity.content%'
      - '%wd_cms.admin.config.controller.content%'
      - '@doctrine.orm.default_entity_manager'
      - '%wd_cms.custom_contents%'
      - '%wd_cms.admin.content.media%'
      - '@service_container'
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Content, show_in_dashboard: false }
    public: true

  cms.admin.cms_content_slider:
    class: '%wd_cms.admin.config.class.content_slider%'
    arguments:
      - ~
      - '%wd_cms.admin.config.entity.content_slider%'
      - '%wd_cms.admin.config.controller.content_slider%'
      - '%wd_cms.admin.content.media%'
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: ContentSlider, show_in_dashboard: false }
    public: true

  cms.admin.cms_menu:
    class: '%wd_cms.admin.config.class.menu%'
    arguments: [~, WebEtDesign\CmsBundle\Entity\CmsMenu, '%wd_cms.admin.config.controller.menu%', '@doctrine.orm.default_entity_manager', '@cms.page_provider']
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Menu }
    calls:
      - [setTranslationDomain, ['cms']]
#      - [setTemplate, ['list', '@@WebEtDesignCms/menu/list.html.twig']]
      - [setTemplate, ['button_create', '@@WebEtDesignCms/admin/menu/actionButtons/button_create.html.twig']]
      - [addChild, ['@cms.admin.cms_menu_item', 'menu']]
    public: true

  cms.admin.cms_menu_item:
    class: WebEtDesign\CmsBundle\Admin\CmsMenuItemAdmin
    arguments:
      - ~
      - WebEtDesign\CmsBundle\Entity\CmsMenuItem
      - WebEtDesign\CmsBundle\Controller\Admin\CmsMenuItemAdminController
      - '@doctrine.orm.default_entity_manager'
      - '@cms.page_provider'
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: MenuItem, show_in_dashboard: false }
    calls:
      - [setTemplate, ['edit', '@@WebEtDesignCms/admin/menuItem/edit.html.twig']]
    public: true


  cms.admin.cms_shared_block:
    class: WebEtDesign\CmsBundle\Admin\CmsSharedBlockAdmin
    arguments:
      - ~
      - WebEtDesign\CmsBundle\Entity\CmsSharedBlock
      - WebEtDesign\CmsBundle\Controller\Admin\CmsSharedBlockAdminController
      - '@doctrine.orm.default_entity_manager'
      - '%wd_cms.cms%'
      - '%wd_cms.custom_contents_form_themes%'
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: Block partagé }
    calls:
      - [setTemplate, ['list', '@@WebEtDesignCms/admin/sharedBlock/list.html.twig']]
      - [setTemplate, ['button_create', '@@WebEtDesignCms/admin/sharedBlock/actionButtons/button_create.html.twig']]

    public: true

  cms.admin.cms_content_has_shared_block:
    class: WebEtDesign\CmsBundle\Admin\CmsContentHasSharedBlockAdmin
    arguments:
      - ~
      - WebEtDesign\CmsBundle\Entity\CmsContentHasSharedBlock
      - ~
    tags:
      - { name: sonata.admin, manager_type: orm, group: CMS, label: content has sharedBlock, show_in_dashboard: false }
    public: true

  cms.admin.cms_page_declination:
    class: WebEtDesign\CmsBundle\Admin\CmsPageDeclinationAdmin
    arguments:
      - ~
      - WebEtDesign\CmsBundle\Entity\CmsPageDeclination
      - WebEtDesign\CmsBundle\Controller\Admin\CmsPageDeclinationAdminController
      - '@doctrine.orm.default_entity_manager'
      - '%wd_cms.templates%'
      - '%wd_cms.vars%'
      - '%wd_cms.custom_contents_form_themes%'
    tags:
      - { name: sonata.admin, manager_type: orm, group: 'CMS', label: 'Page déclinaison', show_in_dashboard: false }
    public: true

  # ===============================================
  # CMS CUSTOM CONTENTS
  # ===============================================

  cms.custom_content.user:
    public: true
    class: WebEtDesign\CmsBundle\Services\EntityContent
    arguments:
      - '@doctrine.orm.entity_manager'
      - '%wd_cms.admin.content.user%'
      - false

  cms.custom_content.users:
    public: true
    class: WebEtDesign\CmsBundle\Services\EntityContent
    arguments:
      - '@doctrine.orm.entity_manager'
      - '%wd_cms.admin.content.user%'
      - true
